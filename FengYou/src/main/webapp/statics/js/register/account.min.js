$(document)
		.ready(
				function() {

					// 登陆和找回密码切换
					$(".forgot-pwd").click(
							function() {

								$('#mobileCode').val('');
								$('#mobileNo').val('');

								if (!$('.step2').hasClass('hide')) {
									$('.step1').removeClass('hide');
									$('.step2').addClass('hide');
								}

								$(".login-info, .login-wrapper").fadeOut(300,
										function() {
											$(".forgot-wrapper").fadeIn(200);
										});
							});
					$(".forgot-go-login").click(function() {
						$(".forgot-wrapper").fadeOut(300, function() {
							$(".login-info, .login-wrapper").fadeIn(200);
						});
						$('#mobileNo,#mobileCode').val('');
						$('#pwd1,#pwd2').val('');

						$('#sendCodeBtn').removeClass('hide');
						$('#sendCodeBtn').next().addClass('hide');
						clearInterval(_time);
						$('#mobileNo').removeAttr('disabled')
					});

					// 登录按钮
					$('#loginBtn')
							.click(
									function(e) {

										// 用户名
										var userName = $('#userName').val();
										var patrn = /^\d{11}$/;
										if (!patrn.exec(userName)) {
											$('.login-error').show().find('p')
													.text('请正确输入手机号码。');
											return false;
										}
										// 密码
										var password = $('#password').val();
										if ($.trim(password) == '') {
											$('.login-error').show().find('p')
													.text('请输入密码。');
											return false;
										}
										var geetest_challenge = $(
												"input:hidden[name='geetest_challenge']")
												.val();
										var geetest_validate = $(
												"input:hidden[name='geetest_validate']")
												.val();
										var geetest_seccode = $(
												"input:hidden[name='geetest_seccode']")
												.val();
										// 隐藏错误提示区域
										$('.login-error').hide();

										$
												.ajax({
													url : 'deskUserAction/login',
													data : {
														phone : userName,
														password : password,
														geetest_challenge : geetest_challenge,
														geetest_validate : geetest_validate,
														geetest_seccode : geetest_seccode
													},
													type : 'POST',
													success : function(data) {
														if (data == 'success') {
															tipShow(
																	'登录成功',
																	function() {
																		var p = /returnUrl=[^\s]*/;
																		if (location.search == '')
																			window.location.href = 'index';
																		else {
																			var mactches = location.search
																					.match(p);

																			if (mactches.length == 0) {
																				window.location.href = 'index';
																			} else {
																				window.location.href = mactches[0]
																						.replace(
																								'returnUrl=',
																								'');
																			}
																		}
																	})
														} else {
															$('.login-error')
																	.show()
																	.find('p')
																	.text(data);
															$('#captcha')
																	.empty();
															locadHadnler();
														}
													}
												});
										return true
									});

					var handler = function(captchaObj) {
						// 将验证码加到id为captcha的元素里
						captchaObj.appendTo("#captcha");

						if (captchaObj.getValidate() == false) {
							// alert("312");
							// refresh()
						}
						// captchaObj
						// alert(captchaObj.getValidate());
					};
					var locadHadnler = function() {

						$.ajax({
							// 获取id，challenge，success（是否启用failback）
							url : "managerLoginAction/StartCaptcha",
							type : "get",
							dataType : "json", // 使用jsonp格式
							success : function(data) {
								// alert(data);
								// 使用initGeetest接口
								// 参数1：配置参数，与创建Geetest实例时接受的参数一致
								// 参数2：回调，回调的第一个参数验证码对象，之后可以使用它做appendTo之类的事件
								initGeetest({
									gt : data.gt,
									challenge : data.challenge,
									product : "float",
									offline : !data.success
								}, handler);
							}
						});
					}

					locadHadnler();
					// 密码框回车
					$('#password').keydown(function(e) {
						if (e.which == 13) {
							$('#loginBtn').trigger('click');
						}
					});

					// 确认验证码
					$('#confirmCodeBtn').click(function(e) {
						if ($('#mobileNo').val() == '') {
							alert('请输入手机号');
							return false;
						}
						var mobileCode = $.trim($('#mobileCode').val());
						var patrn = /^\d{6}$/;
						if (!patrn.exec(mobileCode)) {
							alert('请正确输入验证码');
							return false;
						}
						$.ajax({
							url : '/account/find_pwd',
							data : {
								mobileCode : mobileCode
							},
							type : 'POST',
							success : function(data) {
								if (data == 'success') {
									// 显示修改密码
									$('.step1').addClass('hide');
									$('.step2').removeClass('hide');
								} else {
									alert(data);
								}
							}
						});
					});
					// 确认密码
					$('#confirmPwdBtn').click(function(e) {
						var pwd1 = $.trim($('#pwd1').val());
						var pwd2 = $.trim($('#pwd2').val());
						var patrn = /^.{6,20}$/;
						if (!patrn.exec(pwd1)) {
							// alert('请输入6-20位的密码！');
							tipShow('请输入6-20位的密码!', function() {
							});
							return false;
						}
						if (pwd1 != pwd2) {
							// alert('两次输入的密码不一致');
							tipShow('两次输入的密码不一致', function() {
							});
							return false;
						}
						var mobileNo = $.trim($('#mobileNo').val());
						var mobileCode = $.trim($('#mobileCode').val());
						$.ajax({
							url : '/account/modify_pwd',
							data : {
								mobileNo : mobileNo,
								pwd : pwd1,
								mobileCode : mobileCode
							},
							type : 'POST',
							success : function(data) {
								if (data == 'success') {
									// 修改成功后续操作
									tipShow('修改成功，点击确认到登陆页进行登陆', function() {
										location.href = "signin";
									})
								} else {
									alert(data);
								}
							}
						})
					});

					// 刷新验证码
					$('.recode-refresh').click(function(e) {
						$.ajax({
							url : '/account/captcha?random=' + Math.random(),
							type : 'GET',
							success : function(data) {
								$('.recode-img').attr('src', null);
								$('.recode-img').attr('src', data);
							}
						});
					});

					// 验证用户名
					var validateMobile = function() {
						var _v;
						var mobileNo = $.trim($('#mobileNo').val());
						var patrn = /^\d{11}$/;
						if (!patrn.exec(mobileNo)) {
							// alert('请输入正确手机号');
							return false;
						}
						var _this = $(this);
						var _next = _this.next();
						$.ajax({
							url : '/account/valid_mobile',
							data : {
								mobileNo : mobileNo
							},
							type : 'GET',
							success : function(data) {
								if (data == 'success') {
									_v = false;

								} else {
									_v = true;
								}
							}
						});
						// console.log(_v);
						return _v;
					}
					// 密码
					var validatePws = function() {
						var pwd1 = $.trim($('#pwd1').val());
						var patrn = /^.{6,20}$/;
						if (!patrn.exec(pwd1)) {
							return false;
						}
						if (pwd1 != pwd2) {
							// alert('两次输入的密码不一致');
							return false;
						}
						return true;
					}
					// 确认密码
					var validateConfirmPwd = function() {
						var pwd1 = $.trim($('#pwd1').val());
						var pwd2 = $.trim($('#pwd2').val());
						if (pwd1 != pwd2) {

							return false;
						}
						return true;
					}
					// 验证邮箱
					var validateEmail = function() {
						return false;
					}
					// 验证用户名
					var validateName = function() {
						return false;
					}
					// 验证码
					var validateCode = function() {
						return false;
					}

				});

$(function() {
	var _time;
	// 发送验证码
	$('#sendCodeBtn').click(function() {
		var mobileNo = $.trim($('#mobileNo').val());
		var patrn = /^\d{11}$/;
		if (!patrn.exec(mobileNo)) {
			alert('请输入正确手机号');
			return false;
		}
		var _this = $(this);
		var _next = _this.next();
		$.get('deskUserAction/find_pwd', {
			mobileNo : mobileNo
		}, function(data) {
			alert(data);
			if (data == 'success') {
				_this.addClass('hide');
				_next.removeClass('hide');
				// 显示倒计时
				var _start = 120;
				_time = setInterval(function() {
					if ((--_start) == 0) {
						_this.removeClass('hide');
						_next.addClass('hide');
						clearInterval(_time);
						$('#mobileNo').removeAttr('disabled')
					} else {
						_next.text(_start + '秒后重新发送');
						$('#mobileNo').attr('disabled', 'disabled');
					}

				}, 1000);
			}
		});
	});

});
